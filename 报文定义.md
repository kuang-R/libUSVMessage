报文定义
==============
重新设计合适的报文定义，在缩减报文长度的同时增加报文传输信息量。

## 目录
- [报文格式定义](#报文格式定义)
- [自定义数据](#自定义数据)
- [nano与427的报文](#nano与427的报文)
- [nano与上位机的报文](#nano与上位机的报文)

### 报文格式定义
------------------
#### 报文结构
描述报文的整体结构

|序号|长度|源地址|目的地址|类别|指令|参数|校验码|结束符|
|---|---|---|---|---|---|---|---|---
|uint32_t|int32_t|'S'+uint16_t|'D'+uint16_t|uint8_t|uint8_t|基于定义|16bits|0xFF
|4 bytes|4 bytes|3 bytes|3 bytes|1 byte|1 byte|unknown|2 byte|1 byte

#### 设计说明
- 机器采用小端存储
- 考虑到报文转化的一致性与携带信息量，所有数据均使用计算机内置的数据结构
- 抛弃使用字符串识别报文类别的方式，使用枚举更好

#### 算法设计
##### 算法概述
由于构建算法很简单，所以只描述接收算法。该报文最小长度为19，只有当缓冲区长度超过19时才需要处理。
- 在相应位置找到'S'（source）和'D'(distance)
- 得到报文长度
- 根据报文长度验证结束符位置是否为0xFF
- 检查校验码
- 提取报文
##### 接收算法
1. 从头检索字符'S'
2. 'S'之后第三个字符是'R'
3. 'S'之前第四个字符地址为长度len的址
4. 'S'之后len-9的字节为0xFF
5. 验证校验码

#### 发送请求
考虑到发送请求时有可能丢失的情况，现定义通信流程如下
- 主机发送报文时定义每次发送等待回馈延时和重发送次数
- 从机接收到报文时返回专门的return报文
- 单向通信的报文无需返回

### 自定义数据
----------------------
#### 类别段枚举声明
``` C
enum MCategory {
  control = 1,
  rtn,
  data
};
```
#### 指令枚举声明
``` C
enum MCommand {
  // control-有返回报文
  speed = 1,  // usv-427
  salvage,
  beep,
  auto_return,  // usv-host
  auto_advoid,
  go_dest,
  cruise,
  hover,
  // return
  succeed,  // nano-427
  failure,
  connect,  // usv-host
  status
  // data-无返回报文
  gps,
  imu,
  ultrasonic,
  battery,
};
```
#### 无人艇参数声明
``` c
struct IMU {
    float roll;
    float pitch;
    float yaw;
};
struct GPS {
    float latitude;
    float longtitude;
    float altitude;
    float speed;
};
struct Ultrasonic {
    int front;
    int left;
    int right;
};
```

### nano与427的报文
----------------------
#### 报文段详细描述
nano发
|种类|指令|参数格式|参数数据结构|参数长度|参数取值
|---|---|---|---|---|---
|控制|速度|左右电机速度(%)|均为int8_t|2 bytes|0~100
|控制|打捞|无|无|0 byte|无
|控制|蜂鸣|蜂鸣次数|int8_t|1 byte|1~5,-1表示一直蜂鸣,0表示停止蜂鸣

nano收
|种类|指令|参数格式|参数数据结构|参数长度|参数取值
|---|---|---|---|---|---
|返回|成功|种类+指令|均为uint8_t|2 bytes|如枚举定义所示
|返回|失败|种类+指令|均为uint8_t|2 bytes|如枚举定义所示
|数据|gps|纬度+经度+海拔+速度(m/s)|均为float|16 bytes
|数据|imu|roll+pitch+yaw|均为float|12 bytes
|数据|超声波|前(cm)+左(cm)+右(cm)|均为int32_t|12 bytes|0-500
|数据|电量|电压值(V)|float|4 bytes

### nano与上位机的报文
------------------------
#### 状态报文
考虑到上位机(host)作为用户控制端，会直接改变无人艇的运行状态，以及对ros通信可靠性的信任。
host发出的控制报文不会返回return报文。

有两种情况无人艇会发送状态报文
- 接受到control报文后
- 当艇状态改变（如自动返航触发）时
#### 数据报文
每2s发送一次gps，imu，battery，超声波报文。
#### connect报文
关于connect报文，host端与nano端每秒都会发出一条connect报文。如果超过10s没有受到connect报文，显示连接断开。
#### 报文段详细描述
nano 发
|种类|指令|参数格式|参数数据结构|参数长度|参数取值
|---|---|---|---|---|---
|返回|连接|无|无|0 byte|无
|返回|状态|艇状态+自动返航开关+自动避障开关|均为uint8_t|3 bytes|0表示关，非0表示开
|数据|gps|纬度+经度+海拔+速度(m/s)|均为float|16 bytes
|数据|imu|roll+pitch+yaw|均为float|12 bytes
|数据|超声波|前(cm)+左(cm)+右(cm)|均为int32_t|12 bytes|0-500
|数据|电量|电压值(V)|float|4 bytes

nano收
|种类|指令|参数格式|参数数据结构|参数长度|参数取值
|---|---|---|---|---|---
|控制|切换到漂浮状态|无|无|0 byte|无
|控制|速度|左右电机速度(%)|均为int8_t|2 bytes|0~100
|控制|开关自动返航|布尔|uint8_t|1 byte|0关闭自动返航，非0开启自动返航
|控制|开关自动避障|布尔|uint8_t|1 byte|0关闭自动避障，非0开启自动避障
|控制|打捞|无|无|0 byte|无
|控制|到达目标位置|纬度+经度|均为float|8 bytes|
|控制|巡航|k个经纬度，k>3|均为float|16×k bytes|在划分的多边形区域续航
|数据|连接|无|无|0 byte|无
